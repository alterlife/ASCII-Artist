<html>
    <head>
        <title>ASCII Artist</title>
    </head>

    <script>
        function inputToImage(input, img) {
            return new Promise((resolve, reject) => { 
                let reader = new FileReader()
                if (!img)
                    img = document.createElement("img");
                reader.onloadend = function() {
                    console.log('working ...')
                    img.src = reader.result;
                    resolve(img);
                }
                reader.onerror = reader.onabort = (e) => reject(e);
                reader.readAsDataURL(input.files[0]);
            });
        }

        function imageToCanvas(img, canvas, xresize, yresize) {
            img.crossOrigin = "Anonymous";

            if(!canvas)
                canvas = document.createElement('canvas');
            
            return new Promise( function (resolve, reject) {
                let loadCanvas = function () {
                    canvas.height = xresize || img.height;
                    canvas.width = yresize || img.width;

                    canvas.getContext("2d").drawImage(img, 0, 0, canvas.width, canvas.height);
                    return resolve(canvas);
                }
                if(!img.complete)
                    img.onload = loadCanvas();  // race condition?
                else
                    loadCanvas();

            });
        }

        function inputToCanvas(input, canvas, width, height) {
            return inputToImage(input)
                    .then((img) => imageToCanvas(img, canvas, width, height)
                );
        }

        function canvasToHTML(canvas, text) {
            let context = canvas.getContext("2d");
            let textIndex = 0;
            let HTMLOut = "";

            text = text.replace(/\s/g,'');

            for(let y = 0; y < canvas.height; y++) {
                for (let x = 0; x < canvas.width; x++) {
                    let imgData=context.getImageData(x,y,1,1);

                    HTMLOut += "<span style='color: rgb(" + imgData.data[0] +  "," +  imgData.data[1] + "," +  imgData.data[2] + ")'>" + text.charAt(textIndex) + "</span>";   // Possible improvement for continuous pixels.

                    textIndex = (textIndex + 1) % text.length;
                }
                HTMLOut += "<br>";
            }

            console.log(HTMLOut);

            return HTMLOut;
        }

        function canvasToText(canvas, text) {
            let context = canvas.getContext("2d");
            let textIndex = 0;
            let textOut = "";


            for(let y = 0; y < canvas.height; y++) {
                for (let x = 0; x < canvas.width; x++) {
                    let imgData=context.getImageData(x,y,1,1);
                    index = Math.round( (imgData.data[0] + imgData.data[1] + imgData.data[2]) / (255*3) * (text.length-1) ) ;

                    console.log(index);

                    textOut += text[index];
                }
                textOut += "\n";
            }

            console.log(textOut);
            return "<pre>" + textOut + "</pre>";
        }


        function convertHTML(width, height, text) {
            alert('convert to HTML started');

            // 1. Create a canvas of appropriate size
            imageToCanvas(document.querySelector('#img'), null, 40, 120).then((canvas) => {

                // Convert to HTML and assign to the output div.
                document.querySelector("#result").innerHTML = canvasToHTML(canvas, "the quick brown fox jumps over the lazy dog.");
                
                alert('convert to HTML completed... Scroll down!');
            });
        }
        
        function convertText(width, height, scale) {
            alert('convert to text started');
            // 1. Create a canvas of the appropriate size
            imageToCanvas(document.querySelector('#img'), null, 40, 120).then((canvas) => {
                // Convert to text, wrap in a 'pre' and assign to the output div.
                document.querySelector("#result").innerHTML = canvasToText(canvas, "@#:.  ");
                
                alert('convert to text completed... Scroll down!');
            });
        }

    </script>
    <style>
            #step2 img { width: 50%; height: 50%; margin-left: 25%;}
    </style>
    <body>
        <h1>ASCII Artist</h1>


        <div id="step1"> <!-- Uploaded image to image. -->
            <input type="file" id="source_image" onchange="inputToImage(this, document.querySelector('#img'), 400, 400)">
        </div>

        <div id="step2" style='background-color:aquamarine'> 
            <img id="img" src="test.png">
            
            <div id="params">
            xresize: <input id="xresize" value="80">
            yresize: <input id="yresize" value="80">
            <input type="checkbox" id="keepratio"> Keep Aspect Ratio

                <div id="color">
                    <textarea id="colortext">
                            The quick brown fox jumps over the lazy dog.
                    </textarea>

                    <input value="Convert to HTML" type="button" onclick="convertHTML()">
                </div>
                <div id="bnw">
                    <input value="@#!:. " id="">
                    <input value="Convert to Plain Text" type="button" onclick="convertText()">
                </div>
            </div>

        </div>

        <div id="result" style="font-family:'Courier New', Courier, monospace;">
        </div>

    </body>
</html>